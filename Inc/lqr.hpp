# pragma once
#include <cmath>
#include "config.hpp"
class LQR
{
protected:
    float LQRKbuf[LQR_K_NUM][12] =
    {
        /* Normal -K    L=0.150000      R00=2.00        R11=1.00 */
        {71.74399, 10.291710, 6.773399, 13.227805, 34.303614, 10.781166, -43.842445, -7.651665, -5.717753, -10.784869, 79.874031, 20.585260},
        /* OffGround -K L=0.150000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -43.842445, -7.651665, 0, 0, 0, 0},
        /* Normal -K    L=0.160000      R00=2.00        R11=1.00 */
        {73.87979, 10.662416, 6.920297, 13.390770, 33.069148, 10.416645, -42.916349, -7.520631, -5.555440, -10.385086, 80.890790, 20.901234},
        /* OffGround -K L=0.160000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -42.916349, -7.520631, 0, 0, 0, 0},
        /* Normal -K    L=0.170000      R00=2.00        R11=1.00 */
        {75.86313, 11.018514, 7.051780, 13.534793, 31.879128, 10.065558, -41.939311, -7.382108, -5.390838, -9.996993, 81.824329, 21.191620},
        /* OffGround -K L=0.170000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -41.939311, -7.382108, 0, 0, 0, 0},
        /* Normal -K    L=0.180000      R00=2.00        R11=1.00 */
        {77.71145, 11.362095, 7.169873, 13.662792, 30.734515, 9.728115, -40.932096, -7.239166, -5.226269, -9.622457, 82.680542, 21.458194},
        /* OffGround -K L=0.180000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -40.932096, -7.239166, 0, 0, 0, 0},
        /* Normal -K    L=0.190000      R00=2.00        R11=1.00 */
        {79.43951, 11.694867, 7.276256, 13.777103, 29.635607, 9.404316, -39.910453, -7.094107, -5.063416, -9.262529, 83.465275, 21.702745},
        /* OffGround -K L=0.190000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -39.910453, -7.094107, 0, 0, 0, 0},
        /* Normal -K    L=0.200000      R00=2.00        R11=1.00 */
        {81.05996, 12.018246, 7.372345, 13.879633, 28.582172, 9.094015, -38.886330, -6.948654, -4.903483, -8.917701, 84.184201, 21.927020},
        /* OffGround -K L=0.200000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -38.886330, -6.948654, 0, 0, 0, 0},
        /* Normal -K    L=0.210000      R00=2.00        R11=1.00 */
        {82.58374, 12.333422, 7.459339, 13.971961, 27.573562, 8.796947, -37.868768, -6.804099, -4.747322, -8.588080, 84.842735, 22.132691},
        /* OffGround -K L=0.210000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -37.868768, -6.804099, 0, 0, 0, 0},
        /* Normal -K    L=0.220000      R00=2.00        R11=1.00 */
        {84.02038, 12.641405, 7.538272, 14.055411, 26.608811, 8.512770, -36.864556, -6.661405, -4.595521, -8.273510, 85.445985, 22.321334},
        /* OffGround -K L=0.220000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -36.864556, -6.661405, 0, 0, 0, 0},
        /* Normal -K    L=0.230000      R00=2.00        R11=1.00 */
        {85.37824, 12.943062, 7.610036, 14.131106, 25.686713, 8.241078, -35.878740, -6.521279, -4.448464, -7.973656, 85.998722, 22.494422},
        /* OffGround -K L=0.230000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -35.878740, -6.521279, 0, 0, 0, 0},
        /* Normal -K    L=0.240000      R00=2.00        R11=1.00 */
        {86.66471, 13.239139, 7.675405, 14.200005, 24.805890, 7.981427, -34.915004, -6.384235, -4.306386, -7.688065, 86.505372, 22.653316},
        /* OffGround -K L=0.240000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -34.915004, -6.384235, 0, 0, 0, 0},
        /* Normal -K    L=0.250000      R00=2.00        R11=1.00 */
        {87.88632, 13.530286, 7.735058, 14.262932, 23.964845, 7.733350, -33.975966, -6.250634, -4.169405, -7.416208, 86.970016, 22.799272},
        /* OffGround -K L=0.250000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -33.975966, -6.250634, 0, 0, 0, 0},
        /* Normal -K    L=0.260000      R00=2.00        R11=1.00 */
        {89.04888, 13.817070, 7.789590, 14.320600, 23.162005, 7.496361, -33.063409, -6.120720, -4.037557, -7.157510, 87.396400, 22.933439},
        /* OffGround -K L=0.260000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -33.063409, -6.120720, 0, 0, 0, 0},
        /* Normal -K    L=0.270000      R00=2.00        R11=1.00 */
        {90.15758, 14.099986, 7.839523, 14.373627, 22.395757, 7.269974, -32.178462, -5.994648, -3.910810, -6.911372, 87.787951, 23.056869},
        /* OffGround -K L=0.270000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -32.178462, -5.994648, 0, 0, 0, 0},
        /* Normal -K    L=0.280000      R00=2.00        R11=1.00 */
        {91.21705, 14.379471, 7.885321, 14.422554, 21.664477, 7.053701, -31.321748, -5.872499, -3.789086, -6.677189, 88.147794, 23.170518},
        /* OffGround -K L=0.280000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -31.321748, -5.872499, 0, 0, 0, 0},
        /* Normal -K    L=0.290000      R00=2.00        R11=1.00 */
        {92.23145, 14.655912, 7.927392, 14.467850, 20.966548, 6.847064, -30.493490, -5.754302, -3.672271, -6.454360, 88.478774, 23.275258},
        /* OffGround -K L=0.290000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -30.493490, -5.754302, 0, 0, 0, 0},
        /* Normal -K    L=0.300000      R00=2.00        R11=1.00 */
        {93.20450, 14.929649, 7.966099, 14.509929, 20.300380, 6.649595, -29.693606, -5.640043, -3.560229, -6.242294, 88.783473, 23.371877},
        /* OffGround -K L=0.300000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -29.693606, -5.640043, 0, 0, 0, 0},
        /* Normal -K    L=0.310000      R00=2.00        R11=1.00 */
        {94.13956, 15.200984, 8.001765, 14.549151, 19.664420, 6.460840, -28.921780, -5.529675, -3.452804, -6.040419, 89.064238, 23.461093},
        /* OffGround -K L=0.310000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -28.921780, -5.529675, 0, 0, 0, 0},
        /* Normal -K    L=0.320000      R00=2.00        R11=1.00 */
        {95.03966, 15.470187, 8.034678, 14.585837, 19.057164, 6.280362, -28.177519, -5.423131, -3.349831, -5.848185, 89.323193, 23.543556},
        /* OffGround -K L=0.320000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -28.177519, -5.423131, 0, 0, 0, 0},
        /* Normal -K    L=0.330000      R00=2.00        R11=1.00 */
        {95.90752, 15.737497, 8.065093, 14.620267, 18.477161, 6.107740, -27.460196, -5.320321, -3.251138, -5.665062, 89.562264, 23.619855},
        /* OffGround -K L=0.330000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -27.460196, -5.320321, 0, 0, 0, 0},
        /* Normal -K    L=0.340000      R00=2.00        R11=1.00 */
        {96.74564, 16.003127, 8.093240, 14.652687, 17.923016, 5.942572, -26.769090, -5.221147, -3.156551, -5.490548, 89.783196, 23.690523},
        /* OffGround -K L=0.340000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -26.769090, -5.221147, 0, 0, 0, 0},
        /* Normal -K    L=0.350000      R00=2.00        R11=1.00 */
        {97.55623, 16.267267, 8.119325, 14.683318, 17.393396, 5.784474, -26.103412, -5.125498, -3.065894, -5.324165, 89.987568, 23.756042},
        /* OffGround -K L=0.350000      R00=2.00        R11=1.00 */
        {0, 0, 0, 0, 0, 0, -26.103412, -5.125498, 0, 0, 0, 0}
    };

    float LQROutBuf[2] = {0};
    float LQRXerrorBuf[6] = {0};
    float MatLQRNegK_fly[12] = {0};

    float * LQRXRefX;
    float * LQRXObsX;

    float * current_K = (float *) LQRKbuf[0];


public:

    /*[T;Tp] = -K(X_obs - X_ref)*/
    void LQRCal(float *Tout)
    {
        // 1. Calculate Error: X_err = X_obs - X_ref
        // Manually unrolled loop for 6 elements is very fast
        float err0 = this->LQRXObsX[0] - this->LQRXRefX[0];
        float err1 = this->LQRXObsX[1] - this->LQRXRefX[1];
        float err2 = this->LQRXObsX[2] - this->LQRXRefX[2];
        float err3 = this->LQRXObsX[3] - this->LQRXRefX[3];
        float err4 = this->LQRXObsX[4] - this->LQRXRefX[4];
        float err5 = this->LQRXObsX[5] - this->LQRXRefX[5];

        // 2. Calculate U = -K * X_err
        // Matrix multiplication: [2x6] * [6x1] = [2x1]
        // Row 0
        float u0 =  this->current_K[0]  * err0 +
                    this->current_K[1]  * err1 +
                    this->current_K[2]  * err2 +
                    this->current_K[3]  * err3 +
                    this->current_K[4]  * err4 +
                    this->current_K[5]  * err5;

        // Row 1
        float u1 =  this->current_K[6]  * err0 +
                    this->current_K[7]  * err1 +
                    this->current_K[8]  * err2 +
                    this->current_K[9]  * err3 +
                    this->current_K[10] * err4 +
                    this->current_K[11] * err5;

        // 3. Store output
        this->LQROutBuf[0] = u0;
        this->LQROutBuf[1] = u1;
        
        Tout[0] = u0;
        Tout[1] = u1;
    }

    /*根据腿长更新使用的矩阵k
    */
    void refreshLQRK(float LegLenth, bool isFly)
    {
        LegLenth = (LegLenth < LQR_MIN_LEN_CTRL) ? LQR_MIN_LEN_CTRL : LegLenth;
        LegLenth = (LegLenth > LQR_MAX_LEN_CTRL) ? LQR_MAX_LEN_CTRL : LegLenth;
        volatile int ID = std::round((LegLenth - LQR_MIN_LEN_CTRL) / LQR_LEN_RESOLUTION);

        this->current_K = (float *) LQRKbuf[2 * ID + isFly];

    }

    // Modified to accept raw float pointers or extract data pointer from arm_matrix_instance_f32 if needed
    void InitMatX(float *pMatXRef, float *pMatXObs) 
    {
        // Store pointers to the actual data arrays
        this->LQRXRefX = pMatXRef;
        this->LQRXObsX = pMatXObs;
    }

};
